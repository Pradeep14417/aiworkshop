<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Caf√© Control ‚Äî Live Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            coffee: {
              50: '#F8F4F1',
              100: '#EFE6DF',
              200: '#DFCCBE',
              300: '#C8A98F',
              400: '#B48864',
              500: '#9D6B3B',
              600: '#84552D',
              700: '#6A4324',
              800: '#4E311A',
              900: '#371F11'
            }
          }
        }
      }
    }
  </script>
  <style>
    /* scroll shadow for panels */
    .shadow-inner-top { box-shadow: inset 0 6px 6px -6px rgba(0,0,0,.2); }
    .shadow-inner-bottom { box-shadow: inset 0 -6px 6px -6px rgba(0,0,0,.2); }
  </style>
</head>
<body class="bg-coffee-50 text-coffee-900 min-h-screen">
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-coffee-100">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-coffee-500 text-white grid place-items-center text-xl">‚òïÔ∏è</div>
      <div>
        <h1 class="text-2xl font-semibold">Caf√© Control ‚Äî Live Orders</h1>
        <p class="text-sm text-coffee-600">Manage orders, watch alerts, and keep service flowing.</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <label for="csvUpload" class="px-3 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition cursor-pointer">
          Upload CSV
        </label>
        <input type="file" id="csvUpload" accept=".csv" class="hidden">
        <button id="btnAddDemo" class="px-3 py-2 rounded-xl bg-coffee-600 text-white hover:bg-coffee-700 transition">Add Demo Order</button>
        <button id="btnAdd5" class="px-3 py-2 rounded-xl bg-coffee-500/10 text-coffee-800 hover:bg-coffee-500/20 transition">+5</button>
        <button id="btnResetData" class="px-3 py-2 rounded-xl text-coffee-700 hover:bg-coffee-50 border border-coffee-200">Reset Data</button>
        <button id="btnClear" class="px-3 py-2 rounded-xl text-coffee-700 hover:bg-red-50 border border-red-200">Clear All</button>
      </div>
    </div>
  </header>

  <section class="max-w-7xl mx-auto px-4 mt-5">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="rounded-2xl bg-white p-4 shadow-sm border border-coffee-100">
        <div class="text-sm text-coffee-600">Total Orders</div>
        <div id="sumTotal" class="text-2xl font-semibold">0</div>
      </div>
      <div class="rounded-2xl bg-white p-4 shadow-sm border border-coffee-100">
        <div class="text-sm text-coffee-600">Ready</div>
        <div id="sumReady" class="text-2xl font-semibold">0</div>
      </div>
      <div class="rounded-2xl bg-white p-4 shadow-sm border border-coffee-100">
        <div class="text-sm text-coffee-600">Pending (Waiting/In Progress)</div>
        <div id="sumPending" class="text-2xl font-semibold">0</div>
      </div>
      <div class="rounded-2xl bg-white p-4 shadow-sm border border-coffee-100">
        <div class="text-sm text-coffee-600">Revenue (Today)</div>
        <div id="sumRevenue" class="text-2xl font-semibold">‚Çπ0.00</div>
      </div>
    </div>
  </section>

  <section class="max-w-7xl mx-auto px-4 mt-4 flex flex-col md:flex-row gap-4">
    <div class="flex items-center gap-3 rounded-2xl bg-white p-3 shadow-sm border border-coffee-100">
      <label class="text-sm text-coffee-700">Auto-Refresh</label>
      <select id="refreshSelect" class="px-3 py-2 rounded-xl bg-coffee-100/60">
        <option value="0">Off</option>
        <option value="5000">Every 5s</option>
        <option value="10000" selected>Every 10s</option>
        <option value="30000">Every 30s</option>
        <option value="60000">Every 60s</option>
      </select>
      <button id="btnTick" class="px-3 py-2 rounded-xl bg-coffee-500 text-white hover:bg-coffee-600">Tick Now</button>
    </div>

    <div class="flex-1 rounded-2xl bg-white p-3 shadow-sm border border-coffee-100">
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <span class="px-2 py-1 rounded-full bg-amber-100 text-amber-800">Waiting</span>
        <span class="px-2 py-1 rounded-full bg-sky-100 text-sky-800">In Progress</span>
        <span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-800">Ready</span>
        <span class="px-2 py-1 rounded-full bg-rose-100 text-rose-800">Cancelled</span>
        <span class="ml-auto text-coffee-600">Local time: <span id="clock">‚Äî</span></span>
      </div>
    </div>
  </section>

  <main class="max-w-7xl mx-auto px-4 mt-5 grid grid-cols-1 lg:grid-cols-3 gap-5 pb-20">
    <section class="lg:col-span-2 rounded-2xl bg-white border border-coffee-100 shadow-sm">
      <div class="p-4 border-b border-coffee-100 flex items-center justify-between">
        <h2 class="text-lg font-semibold">Orders</h2>
        <div class="text-sm text-coffee-600" id="lastUpdate">Last update: ‚Äî</div>
      </div>
      <div id="ordersGrid" class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4 p-4"></div>
    </section>

    <aside class="rounded-2xl bg-white border border-coffee-100 shadow-sm flex flex-col">
      <div class="p-4 border-b border-coffee-100">
        <h2 class="text-lg font-semibold">Alerts Panel</h2>
        <p class="text-sm text-coffee-600">We flag issues that need attention.</p>
      </div>
      <div id="alertsPanel" class="p-4 space-y-2 overflow-auto max-h-80 shadow-inner-top shadow-inner-bottom"></div>
      <div class="p-4 border-t border-coffee-100">
        <h3 class="font-semibold mb-2">Smart Assistant</h3>
        <div id="assistantBox" class="text-sm text-coffee-800 bg-coffee-100/60 rounded-xl p-3"></div>
      </div>
    </aside>
  </main>

  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 max-w-sm w-full space-y-3"></div>
  <template id="orderCardTemplate">
    <div class="rounded-2xl border border-coffee-100 shadow-sm overflow-hidden flex flex-col">
      <div class="px-4 py-2 flex items-center justify-between bg-coffee-100/50">
        <div class="font-medium truncate"><span class="inline-block mr-2">üë§</span><span data-field="customer"></span></div>
        <span data-field="badge" class="text-xs px-2 py-1 rounded-full"></span>
      </div>
      <div class="p-4 space-y-2 flex-1">
        <div class="text-sm text-coffee-700">Items</div>
        <ul data-field="items" class="text-sm list-disc ml-5 space-y-1"></ul>
        <div class="text-sm text-coffee-700">Payment: <span data-field="payment" class="font-medium"></span></div>
        <div class="text-xs text-coffee-600">Placed <span data-field="timestamp"></span></div>
        <div class="text-sm font-semibold">Total: <span data-field="total"></span></div>
      </div>
      <div class="px-4 pb-4 mt-auto space-y-2">
        <div class="flex items-center gap-2">
          <label class="text-sm">Update Status:</label>
          <select data-action="status" class="flex-1 px-3 py-2 rounded-xl bg-coffee-100/60">
            <option value="waiting">Waiting</option>
            <option value="in_progress">In Progress</option>
            <option value="ready">Ready</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button data-action="advance" class="flex-1 px-3 py-2 rounded-xl bg-coffee-600 text-white hover:bg-coffee-700">Advance</button>
          <button data-action="cancel" class="px-3 py-2 rounded-xl border border-rose-200 text-rose-700 hover:bg-rose-50">Cancel</button>
        </div>
      </div>
    </div>
  </template>
  
  <template id="importSummaryToastTemplate">
    <div class="bg-white rounded-xl shadow-lg border border-coffee-100 p-4 relative">
        <button data-action="close-toast" class="absolute top-2 right-2 text-coffee-400 hover:text-coffee-700 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <p class="font-semibold text-coffee-800" data-field="summary"></p>
        <div data-field="error-container" class="mt-2 text-sm">
            <details>
                <summary class="cursor-pointer text-coffee-600 hover:text-coffee-800">Show Details</summary>
                <ul data-field="error-list" class="mt-2 text-xs text-red-700 bg-red-50 p-2 rounded max-h-32 overflow-y-auto">
                    </ul>
            </details>
        </div>
    </div>
  </template>

  <script>
    // ---------- Data & Utilities ----------
    const initialSeed = []; // Placeholder for the default synthetic data
    
    const menu = {
      drinks: [
        { name: 'Espresso', price: 120 },
        { name: 'Americano', price: 150 },
        { name: 'Cappuccino', price: 180 },
        { name: 'Latte', price: 200 },
        { name: 'Mocha', price: 220 },
        { name: 'Iced Latte', price: 210 },
        { name: 'Cold Brew', price: 190 },
        { name: 'Masala Chai', price: 120 },
      ],
      pastries: [
        { name: 'Croissant', price: 130 },
        { name: 'Almond Croissant', price: 160 },
        { name: 'Cinnamon Roll', price: 140 },
        { name: 'Banana Bread', price: 120 },
      ],
      snacks: [
        { name: 'Bagel & Cream Cheese', price: 150 },
        { name: 'Chocolate Muffin', price: 130 },
        { name: 'Blueberry Muffin', price: 130 },
        { name: 'Sandwich (Veg)', price: 190 },
      ],
    };

    const payMethods = ['Card', 'Cash', 'UPI', 'Wallet'];
    const statuses = ['waiting', 'in_progress', 'ready'];
    const currency = (n) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 }).format(n);

    let orders = [];
    let idCounter = 1;
    let timer = null;
    let isInitialSeed = true; // Flag to check if we are on the default dataset

    function now() { return new Date(); }
    function minutesSince(d) { return (now() - d) / 60000; }
    function fmtTime(d) {
      const mins = Math.round(minutesSince(d));
      if (mins < 1) return 'just now';
      if (mins === 1) return '1 min ago';
      return `${mins} mins ago`;
    }

    function randomName() {
      const first = ['Aarav','Isha','Rahul','Priya','Vikram','Ananya','Karan','Meera','Kabir','Riya','Arjun','Diya','Sanjay','Neha'];
      const last = ['S','K','R','P','T','N','B','M'];
      return `${first[Math.floor(Math.random()*first.length)]} ${last[Math.floor(Math.random()*last.length)]}.`;
    }

    function pick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

    function randomItems() {
      // 1-5 items, favor 2-3
      const count = [1,2,2,3,3,4,5][Math.floor(Math.random()*7)];
      const groups = ['drinks','pastries','snacks'];
      const out = [];
      for (let i=0;i<count;i++) {
        const g = pick(groups);
        const item = pick(menu[g]);
        const qty = Math.ceil(Math.random()*2);
        out.push({ name: item.name, price: item.price, qty, type: g });
      }
      return out;
    }

    // Updated to support both randomly generated items (with price, qty) and imported items (list of names)
    function calculateTotal(items, totalField) { 
      // If a pre-calculated total is available (from CSV), use it.
      if (totalField !== undefined) return totalField;
      // Otherwise, calculate from the array of items.
      return items.reduce((s, it) => s + it.price * it.qty, 0); 
    }

    function addRandomOrder() {
      const items = randomItems();
      const o = {
        id: idCounter++,
        customer: randomName(),
        items,
        status: 'waiting',
        payment: pick(payMethods.slice(0, 3)), // Only use Card, Cash, UPI for random
        createdAt: new Date(),
        cancelled: false,
        totalPrice: calculateTotal(items)
      };
      orders.unshift(o);
      isInitialSeed = false;
      render();
    }

    function clearAll() { orders = []; render(); }
    
    function resetData() {
        orders = [...initialSeed];
        idCounter = initialSeed.length + 1;
        isInitialSeed = true;
        render();
    }

    // ---------- CSV Parsing and Validation ----------

    // Simple CSV parser for in-browser processing (supports quoted fields for commas within data)
    function parseCSV(csvText) {
      const rows = csvText.split('\n').filter(r => r.trim() !== '');
      if (rows.length === 0) return { header: [], data: [] };

      // Basic handling for quoted fields and comma separation
      const parseRow = (row) => {
        const result = [];
        let inQuote = false;
        let field = '';
        for (let i = 0; i < row.length; i++) {
          const char = row[i];
          if (char === '"') {
            inQuote = !inQuote;
          } else if (char === ',' && !inQuote) {
            result.push(field.trim());
            field = '';
          } else {
            field += char;
          }
        }
        result.push(field.trim());
        return result;
      };

      const header = parseRow(rows[0]).map(h => h.toLowerCase().replace(/[^a-z0-9_]/g, ''));
      const data = rows.slice(1).map(parseRow);
      
      return { header, data };
    }
    
    const requiredFields = ['customer_name', 'items', 'status', 'payment_method', 'timestamp', 'price_total'];
    const validStatuses = new Set(['waiting', 'in_progress', 'ready', 'cancelled']);
    const validPayments = new Set(['cash', 'card', 'upi', 'wallet']);

    function validateImportedOrder(rowData, header, rowNumber) {
      const order = { id: idCounter + rowNumber - 1, createdAt: null, items: [], cancelled: false, status: null, customer: null, payment: null, totalPrice: null, isImported: true };
      const errors = [];
      const dataMap = {};
      
      header.forEach((h, i) => {
        dataMap[h] = rowData[i] || '';
      });

      // 1. Check for missing required fields
      for (const field of requiredFields) {
        if (!dataMap[field]) {
          errors.push(`Missing required field: '${field}'`);
        }
      }
      
      // 2. Map and validate data
      order.customer = dataMap.customer_name;
      
      // Items (string: comma-separated list of item names)
      order.items = dataMap.items.split(',').map(name => ({ 
        name: name.trim(), 
        // For imported orders, we don't know the exact price/qty per item, 
        // but we need a structure that works with the rest of the app's rendering logic.
        // We'll use a count of 1 for each item mentioned.
        qty: 1 
      }));

      // Status
      const statusValue = dataMap.status.toLowerCase().trim();
      if (validStatuses.has(statusValue)) {
        order.status = statusValue;
        if (order.status === 'cancelled') order.cancelled = true;
      } else {
        errors.push(`Invalid status value: '${dataMap.status}' (must be one of: ${[...validStatuses].join(', ')})`);
      }

      // Payment Method
      const paymentValue = dataMap.payment_method.toLowerCase().trim();
      if (validPayments.has(paymentValue)) {
        order.payment = paymentValue.toUpperCase(); // Convert to standard format for display
      } else {
        errors.push(`Invalid payment method: '${dataMap.payment_method}' (must be one of: ${[...validPayments].join(', ')})`);
      }

      // Timestamp (ISO8601 or YYYY-MM-DD HH:MM)
      const date = new Date(dataMap.timestamp);
      if (isNaN(date.getTime())) {
        errors.push(`Invalid timestamp format: '${dataMap.timestamp}'`);
      } else {
        order.createdAt = date;
      }
      
      // Price Total
      const total = parseFloat(dataMap.price_total);
      if (isNaN(total) || total < 0) {
        errors.push(`Non-numeric or negative price total: '${dataMap.price_total}'`);
      } else {
        order.totalPrice = total;
      }
      
      if (errors.length > 0) {
        return { valid: false, errors };
      }

      return { valid: true, order };
    }
    
    function importCSVOrders(csvContent) {
      const { header, data: rows } = parseCSV(csvContent);
      const importedOrders = [];
      const errors = [];
      
      // Map header indices to required field names
      const headerMap = {};
      header.forEach((h, i) => {
          if (requiredFields.includes(h)) {
              headerMap[h] = i;
          }
      });
      
      // Check if all required fields are present in the header
      const missingHeaders = requiredFields.filter(f => !header.includes(f));
      if (missingHeaders.length > 0) {
          showToast({ 
              summary: `Import failed: Missing required header(s): ${missingHeaders.join(', ')}.`,
              errors: [],
              isError: true 
          });
          return;
      }

      rows.forEach((rowData, index) => {
        const rowNumber = index + 2; // +1 for header, +1 for 0-indexing
        const validation = validateImportedOrder(rowData, header, rowNumber);

        if (validation.valid) {
          importedOrders.push(validation.order);
        } else {
          errors.push({ 
            row: rowNumber, 
            message: validation.errors.join('; ')
          });
        }
      });

      if (importedOrders.length > 0) {
        orders.unshift(...importedOrders);
        orders.sort((a,b)=> b.createdAt - a.createdAt); // Re-sort all orders
        // Update the global ID counter past the new imports
        idCounter += importedOrders.length;
        isInitialSeed = false;
      }

      showToast({
        summary: `Imported ${importedOrders.length} orders, skipped ${errors.length} invalid rows.`,
        errors: errors,
        isError: importedOrders.length === 0 && errors.length > 0
      });
      
      render();
    }
    
    // ---------- Toast/Banner Display ----------
    function showToast({ summary, errors, isError = false }) {
        const container = document.getElementById('toastContainer');
        const tpl = document.getElementById('importSummaryToastTemplate');
        const node = tpl.content.cloneNode(true);
        const toast = node.firstElementChild;
        
        const $ = (sel) => toast.querySelector(sel);
        
        $('[data-field="summary"]').textContent = summary;
        
        if (isError) {
             toast.classList.add('bg-red-100', 'border-red-300');
        } else {
             toast.classList.add('bg-green-100', 'border-green-300');
        }

        const errorContainer = $('[data-field="error-container"]');
        const errorList = $('[data-field="error-list"]');

        if (errors.length === 0) {
            errorContainer.remove();
        } else {
            errors.forEach(e => {
                const li = document.createElement('li');
                li.className = 'my-1';
                li.innerHTML = `<strong>Row ${e.row}:</strong> ${e.message}`;
                errorList.appendChild(li);
            });
            // If all orders were skipped, show the error details open by default
            if (isError) {
                 errorContainer.querySelector('details').open = true;
            }
        }
        
        toast.querySelector('[data-action="close-toast"]').addEventListener('click', () => {
            toast.remove();
        });
        
        container.appendChild(toast);
        
        // Auto-dismiss after 8 seconds unless there are errors
        if (errors.length === 0) {
            setTimeout(() => {
                if (toast.parentNode) toast.remove();
            }, 8000);
        }
    }

    // ---------- Rendering ----------
    function statusBadge(status, cancelled=false) {
      if (cancelled) return { text: 'Cancelled', cls: 'bg-rose-100 text-rose-800' };
      if (status === 'waiting') return { text: 'Waiting', cls: 'bg-amber-100 text-amber-800' };
      if (status === 'in_progress') return { text: 'In Progress', cls: 'bg-sky-100 text-sky-800' };
      return { text: 'Ready', cls: 'bg-emerald-100 text-emerald-800' };
    }

    function render() {
      const grid = document.getElementById('ordersGrid');
      grid.innerHTML = '';
      const tpl = document.getElementById('orderCardTemplate');

      orders.forEach(o => {
        const node = tpl.content.cloneNode(true);
        const $ = (sel) => node.querySelector(sel);
        $('[data-field="customer"]').textContent = o.customer;

        // items list
        const ul = $('[data-field="items"]');
        
        // Check if items are in the standard format (name, price, qty) or imported format (name, qty)
        const isStandard = o.items.length > 0 && o.items[0].price !== undefined;
        
        o.items.forEach(it => {
          const li = document.createElement('li');
          if (isStandard) {
             li.textContent = `${it.name} √ó ${it.qty} ‚Äî ${currency(it.price * it.qty)}`;
          } else {
             // For imported orders, we show the name and treat quantity as 1
             li.textContent = `${it.name} ${it.qty > 1 ? `√ó ${it.qty}` : ''}`;
          }
          ul.appendChild(li);
        });

        $('[data-field="payment"]').textContent = o.payment;
        $('[data-field="timestamp"]').textContent = fmtTime(o.createdAt);
        
        // Use totalPrice if available (imported order), otherwise calculate
        const total = o.totalPrice !== undefined ? o.totalPrice : calculateTotal(o.items);
        $('[data-field="total"]').textContent = currency(total);

        // badge
        const b = statusBadge(o.status, o.cancelled);
        const badge = $('[data-field="badge"]');
        badge.textContent = b.text;
        badge.className = `text-xs px-2 py-1 rounded-full ${b.cls}`;

        // controls
        const select = node.querySelector('[data-action="status"]');
        // Ensure only valid statuses are set on the select
        select.value = statuses.includes(o.status) ? o.status : 'waiting'; 
        
        select.addEventListener('change', () => { 
            o.status = select.value; 
            o.cancelled = false; // Status change overrides cancellation
            renderMeta(); 
            render(); 
        });

        node.querySelector('[data-action="advance"]').addEventListener('click', () => {
          if (o.cancelled) return;
          const idx = statuses.indexOf(o.status);
          o.status = statuses[Math.min(idx+1, statuses.length-1)];
          renderMeta(); render();
        });

        node.querySelector('[data-action="cancel"]').addEventListener('click', () => {
          o.cancelled = true; 
          o.status = 'waiting'; // Technically it's cancelled, but setting base status to 'waiting' for logic compatibility
          renderMeta(); 
          render();
        });

        grid.appendChild(node);
      });

      renderMeta();
      document.getElementById('lastUpdate').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
    }

    function renderMeta() {
      const total = orders.length;
      const ready = orders.filter(o => o.status === 'ready' && !o.cancelled).length;
      const pending = orders.filter(o => (o.status === 'waiting' || o.status === 'in_progress') && !o.cancelled).length;
      
      const revenue = orders.filter(o => !o.cancelled && o.status === 'ready').reduce((s,o)=> {
          // Use totalPrice for imported orders, or calculate it for demo orders
          const orderPrice = o.totalPrice !== undefined ? o.totalPrice : calculateTotal(o.items);
          return s + orderPrice;
      }, 0);

      document.getElementById('sumTotal').textContent = total;
      document.getElementById('sumReady').textContent = ready;
      document.getElementById('sumPending').textContent = pending;
      document.getElementById('sumRevenue').textContent = currency(revenue);

      renderAlerts();
      renderAssistant();
    }

    // ---------- Alerts Panel ----------
    function renderAlerts() {
      const panel = document.getElementById('alertsPanel');
      panel.innerHTML = '';

      const alerts = [];
      // Long waiting (>10 min) ‚Äî includes waiting or in-progress
      orders.forEach(o => {
        const mins = minutesSince(o.createdAt);
        if (!o.cancelled && mins > 10 && (o.status === 'waiting' || o.status === 'in_progress')) {
          alerts.push({ type: 'warning', text: `Order #${o.id} (${o.customer}) waiting ${Math.floor(mins)} mins.` });
        }
      });

      // Large group order: > 5 items total
      orders.forEach(o => {
        // Count items by adding up quantities (qty for demo, 1 for imported)
        const c = o.items.reduce((n, it) => n + (it.qty || 1), 0);
        if (!o.cancelled && c >= 6 && (o.status !== 'ready')) {
          alerts.push({ type: 'info', text: `Large order #${o.id} (${c} items) ‚Äî allocate extra hands.` });
        }
      });

      // Cancelled orders
      orders.filter(o => o.cancelled).forEach(o => {
        alerts.push({ type: 'danger', text: `Order #${o.id} was cancelled by manager.` });
      });

      if (alerts.length === 0) {
        const el = document.createElement('div');
        el.className = 'text-sm text-coffee-600';
        el.textContent = 'No alerts right now. All smooth. ‚ú®';
        panel.appendChild(el);
        return;
      }

      alerts.forEach(a => {
        const row = document.createElement('div');
        const badgeMap = {
          warning: 'bg-amber-100 text-amber-800',
          info: 'bg-sky-100 text-sky-800',
          danger: 'bg-rose-100 text-rose-800'
        };
        row.className = 'flex items-start gap-2 p-2 rounded-xl border border-coffee-100';
        row.innerHTML = `<span class="text-xs px-2 py-1 rounded-full ${badgeMap[a.type]}">${a.type.toUpperCase()}</span><div class="text-sm">${a.text}</div>`;
        panel.appendChild(row);
      });
    }

    // ---------- Smart Assistant ----------
    function renderAssistant() {
      const box = document.getElementById('assistantBox');
      const suggestions = [];

      const queue = orders.filter(o => !o.cancelled && (o.status === 'waiting' || o.status === 'in_progress'));
      
      // Counting logic simplified to count items, regardless of whether they are 'pastries' or 'drinks' in the demo menu
      // Since imported items don't have a 'type', we'll rely on the existing item counting logic for a rough estimate
      
      // Pastry count is only reliable for demo orders. For imported, we'll skip type-specific counts
      const demoQueue = queue.filter(o => !o.isImported);
      const pastryCount = demoQueue.reduce((n,o)=> n + o.items.filter(i=> i.type==='pastries').reduce((s,x)=> s + x.qty, 0), 0);
      const drinkCount = demoQueue.reduce((n,o)=> n + o.items.filter(i=> i.type==='drinks').reduce((s,x)=> s + x.qty, 0), 0);
      
      if (pastryCount >= 8) suggestions.push(`Consider prepping more croissants & pastries ‚Äî ${pastryCount} pastry items in demo queue.`);
      if (drinkCount >= 12) suggestions.push(`Brew another batch ‚Äî ${drinkCount} drinks pending in demo queue.`);

      const longWait = queue.filter(o => minutesSince(o.createdAt) > 12).length;
      if (longWait >= 3) suggestions.push(`Queue aging: ${longWait} orders >12 mins. Re-prioritize oldest tickets.`);

      const cashShare = queue.filter(o => o.payment==='CASH').length / Math.max(queue.length,1);
      if (cashShare > 0.5 && queue.length >= 4) suggestions.push(`High cash share ‚Äî keep change float ready.`);

      const cancelled = orders.filter(o => o.cancelled).length;
      if (cancelled >= 2) suggestions.push(`Review cancellation reasons ‚Äî ${cancelled} today. Consider staff huddle.`);

      if (suggestions.length === 0) suggestions.push('Looks good! Keep steady pace and maintain quality. ‚úÖ');

      box.innerHTML = suggestions.map(s => `<div class="flex items-start gap-2 mb-2"><span>üí°</span><p>${s}</p></div>`).join('');
    }

    // ---------- Auto-Refresh Simulation ----------
    function tickProgress() {
      // Simulate order progress: some waiting -> in_progress, some in_progress -> ready
      orders.forEach(o => {
        if (o.cancelled) return;
        const age = minutesSince(o.createdAt);
        const r = Math.random();
        // The simulation affects both demo and imported orders based on time/status
        if (o.status === 'waiting' && r < Math.min(0.35, 0.1 + age/30)) {
          o.status = 'in_progress';
        } else if (o.status === 'in_progress' && r < Math.min(0.4, 0.05 + age/25)) {
          o.status = 'ready';
        }
      });
      render();
    }

    function setAutoRefresh(ms) {
      if (timer) { clearInterval(timer); timer = null; }
      if (ms && Number(ms) > 0) {
        timer = setInterval(tickProgress, Number(ms));
      }
    }

    // ---------- Clock ----------
    function startClock() {
      const el = document.getElementById('clock');
      const update = () => { el.textContent = new Date().toLocaleTimeString(); };
      update();
      setInterval(update, 1000);
    }

    // ---------- Bootstrap ----------
    function seedInitial() {
      const tempOrders = [];
      let tempIdCounter = 1;

      // Seed with a few demo orders at varied times
      for (let i=0;i<6;i++) {
        const items = randomItems();
        const createdAt = new Date(Date.now() - Math.floor(Math.random()*20)*60000); // within last 20 minutes
        tempOrders.push({ 
            id: tempIdCounter++, 
            customer: randomName(), 
            items, 
            status: pick(statuses), 
            payment: pick(payMethods.slice(0, 3)), // Only use Card, Cash, UPI for random
            createdAt, 
            cancelled: false,
            totalPrice: calculateTotal(items)
        });
      }
      tempOrders.sort((a,b)=> b.createdAt - a.createdAt);
      
      // Save the initial state
      initialSeed.push(...tempOrders);
      orders.push(...tempOrders);
      idCounter = tempIdCounter;
    }

    function bindUI() {
      document.getElementById('btnAddDemo').addEventListener('click', addRandomOrder);
      document.getElementById('btnAdd5').addEventListener('click', () => { for(let i=0;i<5;i++) addRandomOrder(); });
      document.getElementById('btnClear').addEventListener('click', clearAll);
      document.getElementById('btnResetData').addEventListener('click', resetData); // New Reset button
      document.getElementById('btnTick').addEventListener('click', tickProgress);
      
      // CSV Upload Handler
      document.getElementById('csvUpload').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            importCSVOrders(e.target.result);
            // Reset the file input so change event fires again if the same file is chosen
            event.target.value = ''; 
          };
          reader.readAsText(file);
        }
      });
      
      const sel = document.getElementById('refreshSelect');
      sel.addEventListener('change', () => setAutoRefresh(sel.value));
      setAutoRefresh(sel.value);
    }

    window.addEventListener('DOMContentLoaded', () => {
      startClock();
      seedInitial();
      bindUI();
      render();
    });
  </script>
</body>
</html>